# المواصفات الفنية الكاملة لتطبيق Pathkin

**الإصدار: 1.0**
**تاريخ التحديث: 24 يوليو 2024**

## 1. مقدمة ونظرة عامة

### 1.1. هدف المشروع
Pathkin هو تطبيق ويب اجتماعي مصمم ليكون المنصة المثالية للمسافرين والرحالة والمغامرين. يهدف التطبيق إلى إنشاء مجتمع مترابط حيث يمكن للمستخدمين مشاركة خططهم، والعثور على شركاء للسفر أو السكن، واكتشاف الأنشطة والفعاليات، وبناء شبكة من العلاقات مع أشخاص يشاركونهم نفس الشغف.

### 1.2. الجمهور المستهدف
- الرحالة (Backpackers) والمسافرون المنفردون.
- البدو الرقميون (Digital Nomads).
- الطلاب الذين يدرسون في الخارج.
- أي شخص يبحث عن مغامرات وتجارب سفر أصيلة.

### 1.3. المفاهيم الأساسية
- **المغامرات (Adventures):** خطط سفر أو أنشطة ينشرها المستخدمون.
- **القصص (Stories):** مشاركات مؤقتة (صور أو فيديو) تختفي بعد 24 ساعة.
- **توائم الميلاد (Birthday Twins):** ميزة للعثور على مستخدمين يشاركونك نفس تاريخ الميلاد.
- **الرسم البياني الاجتماعي (Social Graph):** نظام المتابعة (Follow/Following) الذي يحدد المحتوى الذي يراه المستخدم.

---

## 2. هيكل التطبيق العام والتنقل

### 2.1. تصميم الواجهة
- **الأجهزة الكبيرة (Desktop/Tablet):** واجهة من 3 أعمدة:
    1.  **قائمة جانبية (SideNav):** ثابتة على اليسار للتنقل الرئيسي.
    2.  **المحتوى الرئيسي (Main Content):** في الوسط، يعرض الشاشة النشطة.
    3.  (مستقبلي) **عمود إضافي:** على اليمين للمعلومات السياقية (اقتراحات، إلخ).
- **الأجهزة الصغيرة (Mobile):** واجهة بعمود واحد مع شريط تنقل سفلي.
    1.  **شريط تنقل سفلي (BottomNav):** للوصول السريع للشاشات الرئيسية.

### 2.2. منطق التنقل (Navigation Logic)
يستخدم التطبيق نظام مكدس (Stack-based) لإدارة الشاشات.
- `resetToScreen(screen)`: ينتقل إلى إحدى الشاشات الرئيسية الخمس (Adventures, Map, Create, Search, Profile) ويعيد تعيين المكدس.
- `pushScreen(screen)`: يضيف شاشة جديدة فوق الشاشة الحالية في المكدس (مثل الانتقال من قائمة الرسائل إلى محادثة معينة).
- `popScreen()`: يزيل الشاشة الحالية ويعود إلى الشاشة السابقة في المكدس.

---

## 3. المصادقة وإدارة المستخدمين (Authentication)

### 3.1. تدفق المصادقة
- **إنشاء حساب:**
    - الحقول المطلوبة: الاسم الكامل، اسم المستخدم (بدون مسافات)، البريد الإلكتروني، كلمة المرور، تاريخ الميلاد، الجنس، الدولة.
    - التحقق: يتم التأكد من عدم استخدام اسم المستخدم أو البريد الإلكتروني من قبل.
- **تسجيل الدخول:** باستخدام البريد الإلكتروني وكلمة المرور.
- **تسجيل الدخول الاجتماعي:**
    - **Google / Facebook:** عند تسجيل الدخول لأول مرة، يتم إنشاء ملف مستخدم جديد تلقائيًا باستخدام المعلومات المتاحة (الاسم، البريد الإلكتروني، الصورة).
- **وضع الضيف (Guest Mode):**
    - يمكن للضيف تصفح المحتوى العام (المغامرات العامة).
    - عند محاولة القيام بأي إجراء يتطلب حسابًا (مثل الإعجاب، التعليق، المتابعة)، يظهر إشعار يطلب منه تسجيل الدخول أو إنشاء حساب.
- **نسيت كلمة المرور:**
    - نافذة منبثقة تطلب البريد الإلكتروني.
    - يتم إرسال رابط لإعادة تعيين كلمة المرور عبر Firebase Authentication.

---

## 4. تفصيل الميزات والشاشات

### 4.1. شاشة المغامرات (Adventures Feed)
- **المحتوى:** تعرض قائمة من "بطاقات المغامرات" مرتبة زمنيًا (الأحدث أولاً). المحتوى يأتي من المستخدمين الذين يتابعهم المستخدم الحالي، بالإضافة إلى مغامراته الخاصة.
- **شريط القصص (Story Reel):**
    - يظهر في الأعلى.
    - يعرض صور المستخدمين الذين لديهم قصص نشطة.
    - إطار متدرج الألوان حول صورة المستخدم الذي لديه قصة لم تتم مشاهدتها بعد.
    - الزر الأول "My Story/Add Story" مخصص للمستخدم الحالي.
- **فلتر أنواع المغامرات:**
    - شريط من الأيقونات يسمح للمستخدم بفلترة المغامرات المعروضة حسب النوع (سفر، هايكنج، إلخ).

### 4.2. القصص (Stories)
- **إنشاء قصة (Add Story Modal):**
    - خياران: التقاط صورة/فيديو مباشر من الكاميرا، أو الرفع من جهاز المستخدم.
    - بعد الاختيار، يتم الرفع والنشر مباشرة.
- **عارض القصص (Story Viewer):**
    - يفتح بملء الشاشة عند النقر على قصة.
    - **شريط التقدم:** في الأعلى، يعرض عدد قصص المستخدم وشريط تقدم للقصة الحالية.
    - **التنقل:**
        - النقر على الثلث الأيسر من الشاشة يعود للقصة السابقة.
        - النقر على الثلثين الأيمنين ينتقل للقصة التالية.
        - الانتقال تلقائي بعد 5 ثوانٍ للصور، أو عند انتهاء الفيديو.
    - **معلومات القصة:** صورة واسم صاحب القصة في الأعلى.
    - **الإدارة:** إذا كان المستخدم هو صاحب القصة، يظهر زر خيارات (...) يسمح له بحذف القصة.
- **الاختفاء التلقائي:** تختفي جميع القصص بعد 24 ساعة من نشرها (يتم الفلترة من جهة العميل).

### 4.3. بطاقة المغامرة (Adventure Card Component)
هذا هو المكون الأساسي لعرض المغامرات في جميع أنحاء التطبيق.
- **رأس البطاقة:**
    - صورة واسم صاحب المغامرة (قابلة للنقر للانتقال لملفه الشخصي).
    - متوسط تقييم المضيف (إن وجد).
    - تاريخ النشر.
    - أيقونة الخصوصية (عام، متابعون، توائم).
    - زر خيارات (...) للمؤلف (تعديل/حذف).
- **محتوى البطاقة:** العنوان (بخط عريض)، الوصف.
- **الوسائط:** إذا كانت موجودة، تعرض صورة أو فيديو.
- **تفاصيل المغامرة:**
    - **علامات (Tags):** نوع المغامرة، الموقع (قابل للنقر لعرضه على الخريطة)، التاريخ، الميزانية.
    - يتم عرض الموقع بشكل مختلف حسب النوع (مثال: "من: [الموقع]" للسفر).
- **شريط الإجراءات (Action Bar):**
    - **اهتمام (Interest):** أيقونة قلب تتغير حالتها وعداد.
    - **تعليق (Comment):** تفتح نافذة تفاصيل المغامرة.
    - **محادثة جماعية (Group Chat):** للانضمام للمحادثة المرتبطة بالمغامرة.
    - **تمييز كمكتمل (Mark as Done):**
        - يظهر فقط للمغامرات الماضية.
        - يتغير لونه حسب الحالة (أصفر للانتظار، أخضر للتأكيد).
    - **مشاركة (Share):** تستخدم واجهة المشاركة الأصلية في الجهاز.
    - **إعادة نشر (Repost):** يتغير لونه عند التفعيل.
    - **حفظ (Save):** أيقونة تتغير حالتها (مملوءة/فارغة) وعداد.

### 4.4. إنشاء وتعديل المغامرات
- **الواجهة:** تصميم يشبه منشورات وسائل التواصل الاجتماعي، مع حقول منظمة في بطاقة واحدة.
- **الحقول المشتركة:**
    - العنوان، الوصف.
    - **مساعد الوصف (AI Helper):** يستخدم Gemini API لتوليد وصف بناءً على العنوان، الكلمات المفتاحية، ونوع المغامرة.
    - **الوسائط:** زر لرفع صورة أو فيديو مع معاينة.
    - **الخصوصية:** قائمة منسدلة (عام، للمتابعين، لتوائم الميلاد).
        - إذا تم اختيار "توائم الميلاد"، يظهر خيار إضافي لجعلها مرئية أيضًا لـ "العامة" أو "المتابعين".
    - تاريخ البدء والانتهاء، الميزانية.
- **الحقول الديناميكية (تتغير حسب `adventureType`):**
    - **السفر (Travel):**
        - حقل "موقع الانطلاق" (From).
        - قائمة ديناميكية من "الوجهات" (Destinations)، مع زر "+ Add Destination".
        - كل حقل موقع يستخدم Google Places Autocomplete.
    - **الفعالية (Event):**
        - حقل موقع قياسي.
        - قائمة منسدلة لـ "فئة الفعالية" (موسيقى، فن، طعام، إلخ).
        - إذا تم اختيار "أخرى"، يظهر حقل نصي لإدخال الفئة.
    - **هايكنج / ركوب الدراجات (Hiking/Cycling):**
        - لا توجد حقول إدخال مباشر للموقع.
        - زر "ارسم المسار على الخريطة" يفتح نافذة الخريطة (`LocationPickerModal`) في وضع `route`.
    - **تطوع / تخييم:** حقل موقع قياسي واحد.
- **اختيار الموقع من الخريطة (`LocationPickerModal`):**
    - نافذة منبثقة تغطي الشاشة.
    - **وضع النقطة (Point Mode):**
        - يمكن للمستخدم البحث عن مكان أو النقر على الخريطة لتحديد نقطة.
    - **وضع المسار (Route Mode):**
        - يطلب من المستخدم تحديد نقطة البداية ثم نقطة النهاية.
        - يرسم المسار بين النقطتين باستخدام Directions API.
- **التعديل (`EditAdventureScreen`):**
    - نفس واجهة الإنشاء ولكن مع ملء الحقول بالبيانات الحالية للمغامرة.
    - عند تغيير نوع المغامرة، يجب مسح (nullify) الحقول الخاصة بالنوع القديم في قاعدة البيانات لتجنب البيانات غير المتناسقة.

### 4.5. شاشة الخريطة (Map Screen)
- **العرض:** خريطة Google بملء الشاشة مع شريط فلاتر في الأعلى.
- **العلامات (Markers):**
    - أيقونات مخصصة لكل نوع مغامرة.
    - تظهر فقط للمغامرات المستقبلية التي تحتوي على إحداثيات.
- **نافذة المعلومات (InfoWindow):** تظهر عند النقر على علامة، تعرض عنوان المغامرة وتاريخها وزر "عرض التفاصيل".
- **رسم المسارات:** عند النقر على علامة مغامرة هايكنج/دراجات، يتم رسم المسار على الخريطة.
- **زر "موقعي":** يطلب إذن الموقع ويعرض موقع المستخدم الحالي على الخريطة.

### 4.6. شاشة البحث (Search Screen)
- **تبويبات:** "المغامرات" و "الأشخاص".
- **بحث المغامرات:**
    - حقل بحث نصي.
    - فلاتر: نوع المغامرة، المدينة (مع اقتراحات تلقائية)، الميزانية القصوى، نطاق التاريخ.
    - زر "عرض على الخريطة" يظهر إذا كانت هناك نتائج تحتوي على إحداثيات.
- **بحث الأشخاص:**
    - بحث بالاسم أو اسم المستخدم.
    - يعرض قائمة بالمستخدمين المطابقين مع أزرار "متابعة" و "مراسلة".
- **رابط لـ "توائم الميلاد":** زر بارز ينقل إلى شاشة البحث عن توائم الميلاد.

### 4.7. الملفات الشخصية (Profile Screens)
- **ملفي الشخصي (`ProfileScreen`):**
    - **العرض:** صورة الغلاف، الصورة الشخصية، الاسم، اسم المستخدم (`@username`)، البلد، متوسط التقييم، السيرة الذاتية.
    - **الإحصائيات:** عدد المغامرات، المتابعون، المتابَعون (قابلة للنقر لفتح قائمة).
    - **الأزرار:** "مشاركة الملف الشخصي"، "الإعدادات".
    - **التبويبات:**
        - **المغامرات:** مغامرات المستخدم.
        - **المحفوظات:** المغامرات التي حفظها.
        - **إعادة النشر:** المغامرات التي أعاد نشرها.
        - **المكتملة:** المغامرات التي أكملها.
        - **الإحصائيات:** رسوم بيانية للأنشطة والدول التي تمت زيارتها.
- **ملف مستخدم آخر (`UserProfileScreen`):**
    - نفس تصميم الملف الشخصي.
    - **الأزرار:** "متابعة/إلغاء المتابعة"، "مراسلة".
    - **منطق الخصوصية:** إذا كان الحساب خاصًا والمستخدم الحالي ليس من المتابعين، يتم حجب المحتوى (التبويبات والمغامرات) وعرض رسالة "هذا الحساب خاص".

### 4.8. الرسائل (Chat)
- **قائمة المحادثات (`ChatScreen`):**
    - **تبويبات:** "المغامرون" (محادثات خاصة) و "المغامرات" (محادثات جماعية).
    - كل عنصر يعرض: الصورة، الاسم، معاينة لآخر رسالة، الوقت، وشارة عدد الرسائل غير المقروءة.
- **شاشة المحادثة (`ChatDetailScreen`):**
    - **الرأس:** صورة واسم الطرف الآخر (أو المجموعة)، مع زر إعدادات للمجموعات.
    - **فقاعات الرسائل:** تصميم مميز لرسائل المستخدم الحالي والآخرين.
    - **أنواع الرسائل:** تدعم النصوص، الصور، الفيديوهات، والرسائل الصوتية.
    - **قائمة خيارات الرسالة (عند الضغط المطول):** "حذف لي"، و "إلغاء الإرسال" (إذا كانت رسالة المستخدم).
- **إدخال الدردشة (`ChatInput`):**
    - حقل نصي ينمو تلقائيًا.
    - زر لإرفاق الوسائط (صور وفيديو).
    - زر الميكروفون:
        - عند الضغط عليه، يبدأ تسجيل رسالة صوتية.
        - تتغير الواجهة لعرض مؤقت التسجيل وزر لإلغاء الإرسال.
        - عند رفع الإصبع، يتم إرسال الرسالة الصوتية.

### 4.9. الإشعارات (Notifications Screen)
- **التجميع:** يتم تجميع الإشعارات حسب التاريخ (اليوم، الأمس، هذا الأسبوع، أقدم).
- **أنواع الإشعارات:**
    - `interest`: فلان أبدى اهتمامه بمغامرتك.
    - `comment`: فلان علّق على مغامرتك.
    - `attendanceRequest`: فلان يطلب تأكيد حضوره. (يحتوي على أزرار "تأكيد" و "رفض").
    - `attendanceConfirmed`: تم تأكيد حضورك.
    - `rateExperience`: اطلب من المستخدم تقييم تجربته بعد تأكيد الحضور.

---

## 5. نماذج البيانات (Data Models)
هذه هي الهياكل الأساسية للبيانات التي سيتم تخزينها في Firestore.

```typescript
// src/types.ts

// User
export interface User {
  id: string;
  name: string;
  username: string;
  email: string;
  avatarUrl?: string;
  coverUrl?: string;
  bio: string;
  interests: string[];
  birthday?: string;
  gender?: 'male' | 'female' | 'other' | 'prefer_not_to_say';
  country?: string;
  followers: string[];
  following: string[];
  repostedAdventures: string[];
  savedAdventures: string[];
  activityLog: ActivityLogEntry[];
  averageRating?: number;
  totalRatings?: number;
  isPrivate: boolean;
  privacySettings: PrivacySettings;
}

// Adventure
export interface Adventure {
  id: string;
  type: AdventureType;
  authorId: string;
  title: string;
  description: string;
  location: string;
  coordinates?: { lat: number; lng: number };
  startDate: string;
  endDate?: string;
  budget: number;
  interestedUsers: string[];
  commentCount: number;
  createdAt: string;
  media?: Media[];
  privacy: AdventurePrivacy;
  subPrivacy?: AdventurePrivacy.Public | AdventurePrivacy.Followers;
  destinations?: { location: string; coordinates: { lat: number; lng: number } }[];
  eventCategory?: string;
  endLocation?: string;
  endCoordinates?: { lat: number; lng: number };
}

// Story
export interface Story {
  id: string;
  authorId: string;
  media: Media;
  createdAt: string;
}

// Conversation
export interface Conversation {
  id: string;
  type: 'private' | 'group';
  participants: string[]; 
  lastMessage?: Message;
  updatedAt: string;
  unreadCount?: { [key: string]: number; };
  // For group chats
  adventureId?: string;
  name?: string;
  imageUrl?: string;
}

// Message
export interface Message {
  id: string;
  senderId: string;
  type: 'user' | 'system';
  content: {
    text?: string;
    media?: Media;
    audio?: { url: string; duration: number };
  };
  createdAt: string;
  isDeletedFor?: string[];
}
```

---

## 6. خدمات الخلفية (Backend Services)

### 6.1. Firebase
- **Authentication:** لإدارة المستخدمين وتسجيل الدخول.
- **Firestore:** قاعدة بيانات NoSQL لتخزين جميع بيانات التطبيق.
- **Storage:** لتخزين الوسائط (صور، فيديوهات، رسائل صوتية).

### 6.2. هيكل Firestore
- `users`: مجموعة لتخزين ملفات المستخدمين.
- `posts`: مجموعة لتخزين المغامرات.
    - `/posts/{adventureId}/comments`: مجموعة فرعية للتعليقات.
- `stories`: مجموعة لتخزين القصص.
- `conversations`: مجموعة لتخزين المحادثات.
    - `/conversations/{convoId}/messages`: مجموعة فرعية للرسائل.
- `notifications`: مجموعة لتخزين الإشعارات.

### 6.3. واجهات برمجة التطبيقات الخارجية (Third-Party APIs)
- **Google Maps Platform:**
    - **Maps JavaScript API:** لعرض الخرائط.
    - **Places API:** للاقتراحات التلقائية للمواقع والحصول على تفاصيل الأماكن.
    - **Directions API:** لرسم المسارات بين نقطتين.
- **Google Gemini API:**
    - لتشغيل ميزة "مساعد الوصف بالذكاء الاصطناعي" في شاشة إنشاء المغامرة.

---

**نهاية الوثيقة**
